<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Guardian Dashboard (Dev Mode)</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #00ffd1;
            --accent-color-darker: #00cca3;
            --border-color: #333333;
            --sidebar-width: 250px;
            --top-nav-height: 60px;
            --bottom-nav-mobile-height: 60px;
            --shadow-color: rgba(0, 255, 209, 0.1);
            --shadow-color-dark: rgba(0, 0, 0, 0.3);
            --warn-color: #ffd700;
            --error-color: #ff4d4d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 0; 
        }
        .loading-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; font-size: 1.5em; color: var(--accent-color);
        }
        .dashboard-wrapper { display: none; }
        .container { display: flex; padding-top: var(--top-nav-height); }
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--top-nav-height); background-color: var(--card-bg-color);
            color: var(--accent-color); display: flex; align-items: center;
            padding: 0 20px; z-index: 1000;
            box-shadow: 0 2px 5px var(--shadow-color-dark);
            border-bottom: 1px solid var(--border-color);
        }
        .top-nav .logo { font-size: 1.8em; font-weight: bold; }
        .user-info { margin-left: auto; display: flex; align-items: center; }
        .user-info #userEmailDisplay { font-size: 0.9em; margin-right: 15px; color: var(--text-color); }
        .user-info #logoutButtonTopNav {
            background: none; border: 1px solid var(--accent-color); color: var(--accent-color);
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .user-info #logoutButtonTopNav:hover { background-color: var(--accent-color); color: var(--bg-color); }
        .top-nav .menu-toggle-desktop { display: none; }
        .sidebar {
            width: var(--sidebar-width); height: calc(100vh - var(--top-nav-height));
            background-color: var(--card-bg-color); padding-top: 20px; position: fixed;
            left: 0; top: var(--top-nav-height); transition: transform 0.3s ease-in-out;
            z-index: 900; border-right: 1px solid var(--border-color); overflow-y: auto;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); z-index: 1100; }
        .sidebar ul { list-style: none; }
        .sidebar ul li a {
            display: block; color: var(--text-color); text-decoration: none;
            padding: 15px 20px; transition: background-color 0.2s ease, color 0.2s ease, border-left 0.2s ease;
            border-left: 3px solid transparent;
        }
        .sidebar ul li a:hover { background-color: rgba(0, 255, 209, 0.1); color: var(--accent-color); }
        .sidebar ul li a.active {
            background-color: rgba(0, 255, 209, 0.2); color: var(--accent-color);
            font-weight: bold; border-left-color: var(--accent-color);
        }
        .sidebar #logoutButtonSidebar {
            display: block; width: calc(100% - 40px); margin: 20px;
            background: none; border: 1px solid var(--error-color); color: var(--error-color);
            padding: 10px; border-radius: 4px; cursor: pointer; text-align: center;
            font-weight: bold; text-transform: uppercase;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar #logoutButtonSidebar:hover{ background-color: var(--error-color); color: var(--card-bg-color); }
        .content-panel { flex-grow: 1; padding: 20px; margin-left: var(--sidebar-width); transition: margin-left 0.3s ease-in-out; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card {
            background-color: var(--card-bg-color); padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color-dark), 0 0 5px var(--shadow-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 16px var(--shadow-color-dark), 0 0 10px var(--accent-color); }
        .card h3 { color: var(--accent-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .card p { margin-bottom: 10px; }
        .card p span { font-weight: bold; color: var(--accent-color); }
        .card ul { list-style-position: inside; padding-left: 5px; }
        .card ul li { margin-bottom: 8px; }
        .card label { display: block; margin-bottom: 5px; font-weight: 500; }
        .card input[type="text"], .card textarea {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px;
            border: 1px solid var(--border-color); background-color: var(--bg-color);
            color: var(--text-color); font-size: 1em; font-family: Helvetica, Arial, sans-serif;
        }
        .card input[type="text"]:focus, .card textarea:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color);
        }
        .progress-ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__background { fill: none; stroke: var(--border-color); }
        .progress-ring__circle { fill: none; stroke: var(--accent-color); stroke-linecap: round; transition: stroke-dashoffset 0.5s ease-out; }
        .progress-ring__text { position: absolute; font-size: 1.5em; font-weight: bold; color: var(--accent-color); }
        .btn {
            background-color: var(--accent-color); color: var(--bg-color); border: none;
            padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; transition: background-color 0.2s ease, transform 0.2s ease;
            display: inline-block; margin-top: 10px; font-family: Helvetica, Arial, sans-serif;
        }
        .btn:hover { background-color: var(--accent-color-darker); transform: scale(1.05); }
        .btn:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: none;}
        .log-console ul { list-style: none; max-height: 200px; overflow-y: auto; padding-right: 10px; }
        .log-console ul li { padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        .log-console ul li:last-child { border-bottom: none; }
        .log-console ul li.log-info { color: var(--text-color); }
        .log-console ul li.log-warn { color: var(--warn-color); }
        .log-console ul li.log-error { color: var(--error-color); }
        .log-console ul li .log-timestamp { color: #888; font-size: 0.8em; margin-right: 8px; }
        .log-console ul li .log-message-text { word-break: break-word; }
        .tab-content h2 { color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tab-content p, .tab-content ul { margin-bottom: 15px; }
        .regulation-card { margin-bottom: 20px; }
        .regulation-card h4 { color: var(--accent-color); margin-bottom: 10px; }
        .ai-assistant-card textarea { min-height: 60px; resize: vertical; }
        #aiResponseArea, #aiUrlAnalysisResult {
            margin-top: 15px; padding: 10px; background-color: rgba(0,0,0,0.2);
            border-left: 3px solid var(--accent-color); min-height: 40px;
            font-style: italic; white-space: pre-wrap;
            display: flex; align-items: center; justify-content: flex-start;
        }
        .ai-note { display:block; margin-top:10px; color: #aaa; font-size: 0.85em;}
        .loader {
            border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color);
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bottom-nav-mobile {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--bottom-nav-mobile-height); background-color: var(--card-bg-color);
            border-top: 1px solid var(--border-color); box-shadow: 0 -2px 5px var(--shadow-color-dark);
            z-index: 999; align-items: stretch;
        }
        .bottom-nav-mobile button {
            flex-grow: 1; background: none; border: none; color: var(--text-color);
            font-size: 0.70em; font-weight: 500; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px 0; transition: color 0.2s ease, background-color 0.2s ease;
            border-right: 1px solid var(--border-color);
        }
        .bottom-nav-mobile button:last-child { border-right: none; }
        .bottom-nav-mobile button:hover { background-color: rgba(0, 255, 209, 0.1); }
        .bottom-nav-mobile button.active { color: var(--accent-color); background-color: rgba(0, 255, 209, 0.05); }
        .bottom-nav-mobile button svg {
            width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor;
            transition: fill 0.2s ease;
        }
        @media (max-width: 768px) {
            body { padding-bottom: var(--bottom-nav-mobile-height); }
            .top-nav .user-info { display: none; }
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 3px 0 10px rgba(0,0,0,0.5); }
            .content-panel { margin-left: 0; padding-bottom: 20px; }
            .bottom-nav-mobile { display: flex; }
            .overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.6); z-index: 1050;
            }
            .sidebar.open ~ .overlay { display: block; }
        }
         @media (min-width: 769px) {
            .sidebar { transform: translateX(0); }
            .content-panel { margin-left: var(--sidebar-width); }
            .bottom-nav-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <p>Loading AI Guardian...</p>
    </div>

    <div class="dashboard-wrapper" id="dashboardWrapper">
        <header class="top-nav">
            <div class="logo">AI Guardian</div>
            <div class="user-info" id="userInfoTopNav">
                <span id="userEmailDisplay"></span>
                <button id="logoutButtonTopNav">Logout</button>
            </div>
        </header>

        <div class="container">
            <aside class="sidebar" id="sidebar">
                <ul>
                    <li><a href="#" class="sidebar-link active" data-target="dashboard-content">Dashboard</a></li>
                    <li><a href="#" class="sidebar-link" data-target="threat-monitor-content">Threat Monitor</a></li>
                    <li><a href="#" class="sidebar-link" data-target="compliance-content">Compliance</a></li>
                    <li><a href="#" class="sidebar-link" data-target="digital-awakening-tab-content">Digital Awakening</a></li>
                    <li><a href="#" class="sidebar-link" data-target="settings-content">Settings</a></li>
                </ul>
                <button id="logoutButtonSidebar">Logout</button>
            </aside>

            <div class="overlay" id="pageOverlay"></div>

            <main class="content-panel" id="contentPanel">
                <section id="dashboard-content" class="tab-content active">
                     <div class="card" style="margin-bottom: 20px;">
                        <h3>Welcome to AI Guardian</h3>
                        <p>Your AI-Powered Cybersecurity & Compliance platform for SMEs.</p>
                    </div>
                    <div class="dashboard-grid">
                        <div class="card threat-status-card">
                            <h3>Threat Status</h3>
                            <p>Threats Detected: <span id="threatsDetected">0</span></p>
                            <p>Critical Vulnerabilities: <span id="criticalVulnerabilities">0</span></p>
                            <p>Last Scan: <span id="lastScanTime">N/A</span></p>
                            <button class="btn" id="runScanButton">Run Quick Scan</button>
                        </div>
                        <div class="card compliance-score-widget">
                            <h3>Compliance Score</h3>
                            <div class="progress-ring-container">
                                <svg class="progress-ring" width="150" height="150">
                                    <circle class="progress-ring__background" stroke-width="12" r="60" cx="75" cy="75"/>
                                    <circle class="progress-ring__circle" id="complianceProgressCircle" stroke-width="12" r="60" cx="75" cy="75"/>
                                </svg>
                                <span class="progress-ring__text" id="compliancePercentage">0%</span>
                            </div>
                            <p style="text-align: center; margin-top: 10px;">Overall SME Compliance Readiness</p>
                        </div>
                        <div class="card digital-awakening-card">
                            <h3>Digital Awakening</h3>
                            <p>Initiate our AI-driven <strong>Digital Awakening Health Check</strong>.</p>
                            <button class="btn" id="launchDigitalAwakening">Launch Health Check</button>
                        </div>
                        <div class="card log-console">
                            <h3>Activity Log & Alert Stream</h3>
                            <ul id="logMessages"></ul>
                        </div>
                        <div class="card ai-assistant-card">
                            <h3>AI Guardian Assistant</h3>
                            <label for="aiQueryInput">Ask about SME security or compliance: </label>
                            <textarea id="aiQueryInput"></textarea>
                            <button class="btn" id="askAIButton">Ask AI Guardian</button>
                            <div id="aiResponseArea">AI Guardian's response will appear here...</div>
                            <small class="ai-note">AI Guardian provides guidance based on our core principles. For specific legal advice, consult a professional.</small>
                        </div>
                    </div>
                </section>

                <section id="threat-monitor-content" class="tab-content">
                    <h2>AI-Powered Threat Monitoring</h2>
                     <p>AI Guardian leverages AI for proactive threat management.</p>
                    <div class="card"><h3>Real-time Threat Feed</h3><p>AI Guardian is actively monitoring. No critical threats detected currently.</p></div>
                    <div class="card" style="margin-top:20px;">
                        <h3>AI Guardian URL Threat Analyzer</h3>
                        <p>Get a preliminary AI-powered analysis of a website's potential threat level.</p>
                        <label for="urlInput">Website URL to Analyze:</label>
                        <input type="text" id="urlInput">
                        <button class="btn" id="analyzeUrlButton">Analyze URL with AI Guardian</button>
                        <div id="aiUrlAnalysisResult">Analysis will appear here...</div>
                         <small class="ai-note">This analysis is powered by AI Guardian. For comprehensive security, always use dedicated tools.</small>
                    </div>
                </section>

                <section id="compliance-content" class="tab-content">
                     <h2>AI-Simplified Compliance Management</h2>
                    <p>AI Guardian helps you navigate complex EU regulations (GDPR, NIS2, EU AI Act, CRA).</p>
                    <div class="regulation-card card"><h4>GDPR</h4><p>AI-assisted RoPAs, DPIA guidance, policy templates.</p><button class="btn btn-small" onclick="triggerHapticFeedback()">Access GDPR Tools</button></div>
                    <div class="regulation-card card"><h4>NIS2 Directive</h4><p>Simplified mandates, incident reporting templates, risk management guidance.</p><button class="btn btn-small" onclick="triggerHapticFeedback()">Explore NIS2 Guidance</button></div>
                    <div class="regulation-card card"><h4>EU AI Act & CRA</h4><p>Guidance on AI system risk, deployer obligations, and CRA.</p><button class="btn btn-small" onclick="triggerHapticFeedback()">Understand AI Act & CRA</button></div>
                    <div class="card" style="margin-top: 20px;">
                        <h3>AI Guardian Document Generation</h3>
                        <p>Let AI Guardian Assistant help you draft foundational compliance documents based on general EU principles for SMEs. These are starting points and require legal review.</p>
                        <button class="btn" id="generateDocsButton">Generate Documents with AI Guardian</button>
                        <div id="docGenerationStatus" style="margin-top: 15px; min-height: 20px;"></div>
                        <div style="margin-top: 20px;">
                            <h4>Generated Privacy Policy (Template)</h4>
                            <textarea id="privacyPolicyOutput" rows="10" readonly style="width: 100%; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px; font-family: monospace; white-space: pre-wrap;"></textarea>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>Generated Terms of Use (Template)</h4>
                            <textarea id="termsOfUseOutput" rows="10" readonly style="width: 100%; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px; font-family: monospace; white-space: pre-wrap;"></textarea>
                        </div>
                        <small class="ai-note" style="color: var(--warn-color); font-weight:bold; margin-top:15px;">
                            IMPORTANT: The documents generated here are basic templates for illustrative purposes only. They are NOT legally binding and do NOT constitute legal advice. Always consult with a qualified legal professional to ensure your documents are complete, accurate, and compliant with all applicable laws and regulations for your specific business and jurisdiction.
                        </small>
                    </div>
                </section>
                <section id="digital-awakening-tab-content" class="tab-content">
                     <h2>The Digital Awakening Program</h2>
                    <p>Your first step to secure growth via an intuitive online assessment.</p>
                    <div class="card"><h3>What you get:</h3><ul><li>Actionable report</li><li>Readiness score</li><li>Prioritized recommendations</li></ul><button class="btn" onclick="triggerHapticFeedback(); document.getElementById('launchDigitalAwakening').click();">Start Health Check</button></div>
                </section>
                <section id="settings-content" class="tab-content">
                    <h2>Platform Settings</h2>
                    <div class="card">
                        <h3>Notification Preferences</h3>
                        <label><input type="checkbox" id="notifCritical" checked> Email alerts for critical threats & compliance deadlines</label><br>
                        <label><input type="checkbox" id="notifSummary" checked> AI-generated weekly security & compliance summary report</label><br>
                        <button class="btn" id="saveSettingsButton">Save Settings</button>
                    </div>
                </section>
            </main>
        </div>

        <nav class="bottom-nav-mobile" id="bottomNavMobile">
            <button data-target="dashboard-content" class="bottom-nav-item active">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
                Dashboard
            </button>
            <button data-target="threat-monitor-content" class="bottom-nav-item">
                <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                Threats
            </button>
            <button data-target="compliance-content" class="bottom-nav-item">
                 <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                Compliance
            </button>
            <button id="mobileMenuToggle">
                 <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                Menu
            </button>
        </nav>
    </div>

    <script>
        // --- Firebase Config and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDV5uecwO9YSqd9oc2c6-Bi2qSeQ60bp6I",
            authDomain: "aiconnect-ion-lejsx1.firebaseapp.com",
            databaseURL: "https://aiconnect-ion-lejsx1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aiconnect-ion-lejsx1",
            storageBucket: "aiconnect-ion-lejsx1.appspot.com",
            messagingSenderId: "673159361095",
            appId: "1:673159361095:web:eea12a3dada63a63ea7762"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUID = null;

        // --- DOM Element Selections ---
        const loadingScreen = document.getElementById('loadingScreen');
        const dashboardWrapper = document.getElementById('dashboardWrapper');
        const sidebar = document.getElementById('sidebar');
        const pageOverlay = document.getElementById('pageOverlay');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const logoutButtonTopNav = document.getElementById('logoutButtonTopNav');
        const logoutButtonSidebar = document.getElementById('logoutButtonSidebar');
        const threatsDetectedEl = document.getElementById('threatsDetected');
        const criticalVulnerabilitiesEl = document.getElementById('criticalVulnerabilities');
        const lastScanTimeEl = document.getElementById('lastScanTime');
        const runScanButton = document.getElementById('runScanButton');
        const complianceProgressCircle = document.getElementById('complianceProgressCircle');
        const compliancePercentageText = document.getElementById('compliancePercentage');
        const radius = complianceProgressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        complianceProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        const launchDigitalAwakeningButton = document.getElementById('launchDigitalAwakening');
        const logMessagesList = document.getElementById('logMessages');
        const MAX_LOG_MESSAGES = 10;
        const notifCriticalCheck = document.getElementById('notifCritical');
        const notifSummaryCheck = document.getElementById('notifSummary');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const aiQueryInput = document.getElementById('aiQueryInput');
        const askAIButton = document.getElementById('askAIButton');
        const aiResponseArea = document.getElementById('aiResponseArea');
        const urlInput = document.getElementById('urlInput');
        const analyzeUrlButton = document.getElementById('analyzeUrlButton');
        const aiUrlAnalysisResultEl = document.getElementById('aiUrlAnalysisResult');
        const bottomNavMobile = document.getElementById('bottomNavMobile');
        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const userInfoTopNav = document.getElementById('userInfoTopNav');
        const generateDocsButton = document.getElementById('generateDocsButton');
        const privacyPolicyOutput = document.getElementById('privacyPolicyOutput');
        const termsOfUseOutput = document.getElementById('termsOfUseOutput');
        const docGenerationStatus = document.getElementById('docGenerationStatus');

        // --- TogetherAI API Details (FOR DEV MODE ONLY - API KEY IS EXPOSED) ---
        // WARNING: This code includes a hardcoded API Key. It is intended for local development 
        // and testing ONLY. DO NOT DEPLOY THIS TO ANY PUBLIC OR PRODUCTION ENVIRONMENT.
        // EXPOSING API KEYS IN CLIENT-SIDE CODE IS A SEVERE SECURITY RISK.
        const TOGETHER_API_KEY = "3b1c02603a0137c8c8b265ef1ed02c3e448c089a44f052ca6acf54210fa6b34c";
        const TOGETHER_API_URL = "https://api.together.xyz/v1/chat/completions";
        const LLM_MODEL = "meta-llama/Llama-3.3-70B-Instruct-Turbo-Free";
        
        // --- THE COMPREHENSIVE AI GUARDIAN SYSTEM PROMPT ---
        const aiGuardianSystemPrompt = `You are Emilio, AI Guardian’s virtual cybersecurity and compliance assistant for European small and medium-sized enterprises (SMEs). In this role, you serve as an always-available expert advisor — essentially a virtual Chief Information Security Officer (CISO) and Compliance Officer — who communicates in friendly, plain language. AI Guardian’s unified platform merges AI-driven cybersecurity with AI-simplified compliance management — covering regulations like GDPR, NIS2, the EU AI Act, and the Cyber Resilience Act — into a single, intuitive interface. Your mission is to keep users secure and compliant by detecting threats early, translating complex regulations into practical steps, and coaching them through security and compliance tasks with confidence and empathy.

# Tone & Style
Use clear, simple language with minimal jargon so that non-technical users can easily understand.
Maintain a warm, empathetic, and supportive tone; never make the user feel ignorant for asking basic questions.
Project confidence and reassurance in your answers, helping the user feel secure and informed.
Stay calm and patient, even if the user is stressed or the situation is urgent.
Avoid sounding like a technical manual or overwhelming the user with unnecessary details; focus on clarity and understanding.

# Core Capabilities
Clearly explain any security alerts, anomalies, or potential threats detected by the platform. Describe what happened, how severe it is, and what immediate steps the user should take to address it.
Answer user questions about EU regulations (like GDPR, NIS2, the EU AI Act, or the Cyber Resilience Act) with straightforward explanations. Focus on what the regulation means for their business in practical terms, avoiding legal jargon.
Guide users through compliance documentation and processes. For example, assist in creating a Record of Processing Activities (RoPA), conducting a Data Protection Impact Assessment (DPIA), preparing a Statement of Applicability (SoA), or carrying out a Fundamental Rights Impact Assessment (FRIA). Explain why each document is important and provide step-by-step help in filling them out or gathering necessary information.
Support the user through the Digital Awakening Health Check process. Encourage them to use this health check as a starting point, and when results are available, explain the findings (security score, identified vulnerabilities, compliance gaps) in plain language. Provide context for any recommendations from the health check and motivate the user to take the next steps towards improvement.
If asked to assess a website or link, perform a risk assessment of the URL. Check for signs of phishing, malware, or other threats (using available threat intelligence data). Clearly explain why a URL might be flagged as risky or considered safe, pointing out key indicators in simple terms (e.g., "This link is not secure because...").
Emphasize the platform’s proactive monitoring when relevant. Let the user know that many security and compliance checks are continuously running in the background. For example, mention that unusual activities trigger immediate alerts, or that the system keeps track of upcoming compliance deadlines. This reinforces that AI Guardian is always working to protect them even when they aren’t actively using it.

# Domain Intelligence
Understand and interpret the AI-driven anomaly detection and predictive scanning that the platform performs. If an anomaly is detected (e.g. by advanced machine learning models like LSTMs or isolation forests monitoring network traffic and user behavior), translate it into a clear explanation of what was noticed and why it might indicate a threat — all without jargon.
Leverage context-aware vulnerability management knowledge: when discussing vulnerabilities, prioritize and explain them based on the SME’s specific environment. For instance, highlight if a vulnerability is actively being exploited in the wild or is particularly critical for their type of business, rather than just quoting a generic severity score.
Translate dense regulatory requirements into actionable advice. If the user asks about a clause or article in GDPR, NIS2, the EU AI Act, or CRA, summarize it in plain terms and outline what actions the SME needs to take to comply, given their context.
Identify and communicate overlaps between different regulations or standards. Show the user how one action (like improving network security or documenting a procedure) can help satisfy multiple compliance requirements at once. This prevents redundant effort and gives the user a holistic view of their security and compliance posture.

# Persona Guidelines
Embody the persona of a friendly, highly knowledgeable expert dedicated to the SME’s digital safety. You are essentially the user’s virtual CISO and Compliance Officer combined — but you always explain things in approachable, non-technical terms.
Always be available and proactive. Serve the user with unwavering patience and promptness, regardless of the time or the simplicity of the question. The user should feel you are a constant, reliable presence guarding their organization.
Act as an educator and coach: break down complex concepts into simple ideas, and guide the user step-by-step through solving problems or completing tasks. Use analogies or relatable examples if it helps comprehension.
Act as a compliance interpreter: understand the intent behind laws and regulations and convey to the user exactly how those rules apply to their business, in everyday language.
Act as a vigilant digital bodyguard: be watchful and protective, alerting the user to risks or issues in a calm manner and guiding them to resolve these issues. Always communicate without causing panic or confusion.
Be mindful of the SME context. Acknowledge that the user may have limited resources (budget, IT staff, time). Tailor your solutions to be practical and feasible for a small business environment. Reinforce that they don’t need to be experts because you are here to help.

# Behavioral Patterning
Make responses actionable, not just informative. Whenever you explain a problem or answer a question, include what the user should do next to improve the situation or stay compliant.
Provide clear, step-by-step guidance when appropriate. For example, if a security incident occurs, you might outline steps to take (e.g., 1. isolate the affected computer, 2. reset relevant passwords, 3. run a malware scan, etc.). This helps the user follow through with confidence.
Integrate AI Guardian’s assistance into your answers. Remind the user of any automatic features or tools that can help (e.g., "Our platform has prepared a template for your DPIA," or "The system will continue to monitor your network for any similar threats"). This shows the user that tedious or complex tasks are being handled with the platform’s help.
Be proactive: don’t always wait for the user to ask. If they address one issue, gently suggest logical next steps or related areas to check, keeping their overall security and compliance in mind. For instance, after resolving a vulnerability, you might prompt, “We should also review your backup settings to further strengthen your defenses.”
Maintain a positive, calm demeanor. If the user is worried or frustrated, acknowledge their feelings and then provide encouragement and solutions. Help them see that with the steps you’re outlining (and with AI Guardian working in the background), the challenge is manageable.
Avoid overwhelming the user. Keep your answers as concise as possible while still fully answering their question. If a topic is complex, break the explanation or process into smaller, digestible parts. Continuously ensure the user understands before moving on, and invite follow-up questions if needed.`;

        // --- UI Enhancement Functions ---
        function triggerHapticFeedback(pattern = 50) { if (navigator.vibrate) { try { navigator.vibrate(pattern); } catch (e) { /* Silently fail */ } } }
        function showLoader(element, message = "Processing...") { triggerHapticFeedback(20); element.innerHTML = `<div class="loader"></div> <span style="margin-left: 5px; font-style:normal;">${message}</span>`; element.style.fontStyle = 'italic'; }
        
        // --- Firebase Auth & Data Logic ---
        auth.onAuthStateChanged((user) => { if (user) { currentUID = user.uid; loadingScreen.style.display = 'none'; dashboardWrapper.style.display = 'block'; userEmailDisplay.textContent = user.email; loadUserData(); handleResize(); } else { window.location.href = 'signin.html'; } });
        function handleLogout() { triggerHapticFeedback(); const userEmailForLog = userEmailDisplay.textContent || "User"; addLogMessageToDB(`${userEmailForLog} logged out.`, 'INFO').finally(() => { auth.signOut(); }); }
        logoutButtonTopNav.addEventListener('click', handleLogout);
        logoutButtonSidebar.addEventListener('click', handleLogout);
        function loadUserData() { if (!currentUID) return; database.ref(`users/${currentUID}/dashboard/threatStatus`).on('value', (s) => { const d = s.val()||{detected:0,critical:0,lastScan:"N/A"}; threatsDetectedEl.textContent=d.detected; criticalVulnerabilitiesEl.textContent=d.critical; lastScanTimeEl.textContent=d.lastScan;}); database.ref(`users/${currentUID}/dashboard/complianceScore`).on('value', (s) => setComplianceProgress(s.val()||0)); database.ref(`users/${currentUID}/activityLog`).orderByKey().limitToLast(MAX_LOG_MESSAGES).on('value', (s) => { logMessagesList.innerHTML=''; s.forEach((c)=>addLogMessageToUI(c.val().message,c.val().type,new Date(c.val().timestamp).toLocaleTimeString()));}); database.ref(`users/${currentUID}/settings/notifications`).once('value',(s)=>{const d=s.val()||{critical:true,summary:true};notifCriticalCheck.checked=d.critical;notifSummaryCheck.checked=d.summary;});}
        function addLogMessageToDB(message, type = 'INFO') { if(!currentUID)return Promise.resolve(); return database.ref(`users/${currentUID}/activityLog`).push({timestamp:new Date().toISOString(),message,type}); }
        runScanButton.addEventListener('click', () => { triggerHapticFeedback(); runScanButton.disabled = true; showLoader(lastScanTimeEl, "Scanning..."); setTimeout(() => { if(!currentUID){runScanButton.disabled=false;lastScanTimeEl.textContent = "N/A"; return;} const nT=Math.floor(Math.random()*3),nV=Math.floor(Math.random()*2),ts=new Date(); const cT=parseInt(threatsDetectedEl.textContent)||0,cV=parseInt(criticalVulnerabilitiesEl.textContent)||0; database.ref(`users/${currentUID}/dashboard/threatStatus`).set({detected:cT+nT,critical:cV+nV,lastScan:`${ts.toLocaleTimeString()} ${ts.toLocaleDateString()}`}); addLogMessageToDB(`Scan: ${nT} threats, ${nV} vulnerabilities.`, 'INFO'); runScanButton.disabled=false; }, 2500); });
        saveSettingsButton.addEventListener('click', () => { triggerHapticFeedback(); saveSettingsButton.disabled = true; if(!currentUID){saveSettingsButton.disabled=false;return;} database.ref(`users/${currentUID}/settings/notifications`).set({critical:notifCriticalCheck.checked,summary:notifSummaryCheck.checked}) .then(()=>{addLogMessageToDB('Settings updated.', 'INFO');alert('Settings Saved!');}) .catch(e=>{addLogMessageToDB('Error saving settings: '+e.message,'ERROR');alert('Error saving.');}) .finally(()=>saveSettingsButton.disabled=false); });
        launchDigitalAwakeningButton.addEventListener('click', () => { triggerHapticFeedback(); launchDigitalAwakeningButton.disabled = true; if(!currentUID){launchDigitalAwakeningButton.disabled=false;return;} database.ref(`users/${currentUID}/digitalAwakening`).update({status:"initiated",lastLaunched:new Date().toISOString()}); setTimeout(()=>{alert('Digital Awakening Health Check initiated!');addLogMessageToDB('Digital Awakening initiated.','INFO');launchDigitalAwakeningButton.disabled=false;}, 500); });

        // --- Navigation & UI Logic ---
        function switchTab(targetId) { sidebarLinks.forEach(l => l.classList.remove('active')); bottomNavItems.forEach(item => item.classList.remove('active')); tabContents.forEach(tc => tc.classList.remove('active')); document.getElementById(targetId).classList.add('active'); const activeSidebarLink = document.querySelector(`.sidebar-link[data-target="${targetId}"]`); if (activeSidebarLink) activeSidebarLink.classList.add('active'); const activeBottomNavItem = document.querySelector(`.bottom-nav-item[data-target="${targetId}"]`); if (activeBottomNavItem) activeBottomNavItem.classList.add('active'); if (window.innerWidth <= 768 && sidebar.classList.contains('open')) { sidebar.classList.remove('open'); pageOverlay.style.display = 'none';}}
        sidebarLinks.forEach(link => { link.addEventListener('click', function(e) { triggerHapticFeedback(30); e.preventDefault(); switchTab(this.getAttribute('data-target')); }); });
        bottomNavItems.forEach(item => { item.addEventListener('click', function() { triggerHapticFeedback(30); switchTab(this.getAttribute('data-target')); }); });
        mobileMenuToggle.addEventListener('click', () => { triggerHapticFeedback(30); sidebar.classList.toggle('open'); pageOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none'; });
        pageOverlay.addEventListener('click', () => { triggerHapticFeedback(30); sidebar.classList.remove('open'); pageOverlay.style.display = 'none'; });
        function setComplianceProgress(p){ complianceProgressCircle.style.strokeDashoffset=circumference-(p/100)*circumference;compliancePercentageText.textContent=`${p}%`;}
        function addLogMessageToUI(m,t='INFO',ts=new Date().toLocaleTimeString()){const i=document.createElement('li');i.innerHTML=`<span class="log-timestamp">[${ts}]</span> <span class="log-message-text">${m}</span>`;i.className=`log-${t.toLowerCase()}`;logMessagesList.insertBefore(i,logMessagesList.firstChild);}
        function handleResize(){ const cp = document.getElementById('contentPanel'); const body = document.body; if(window.innerWidth > 768){ sidebar.classList.remove('open'); pageOverlay.style.display = 'none'; sidebar.classList.remove('collapsed'); cp.style.marginLeft = 'var(--sidebar-width)'; body.style.paddingBottom = '0'; userInfoTopNav.style.display = 'flex'; } else { cp.style.marginLeft = '0'; body.style.paddingBottom = 'var(--bottom-nav-mobile-height)'; if(!sidebar.classList.contains('open')) sidebar.classList.add('collapsed'); else sidebar.classList.remove('collapsed'); userInfoTopNav.style.display = 'none'; }}
        window.addEventListener('resize',handleResize);

        // --- DEV MODE: Live LLM Interaction (API Key is EXPOSED - Local Dev Only) ---
        async function callAIGuardianLLM_DevMode(userContent, targetElement) {
            showLoader(targetElement, "AI Guardian contacting live model...");
            const messages = [{ "role": "system", "content": aiGuardianSystemPrompt }, { "role": "user", "content": userContent }];
            try {
                const response = await fetch(TOGETHER_API_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${TOGETHER_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: LLM_MODEL, messages: messages, max_tokens: 1500, temperature: 0.6 }) 
                });
                triggerHapticFeedback(30); 
                if (!response.ok) { const errTxt = await response.text(); throw new Error(`API Error ${response.status}: ${errTxt}`); }
                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const rawResponse = data.choices[0].message.content.trim();
                    targetElement.textContent = rawResponse;
                    targetElement.style.fontStyle = 'normal';
                    addLogMessageToDB(`AI Guardian (Live) response for: "${userContent.substring(0,70)}..."`, 'INFO');
                    return rawResponse;
                } else { throw new Error("Unexpected API response structure from LLM."); }
            } catch (error) {
                console.error("Error calling AI Guardian LLM (Live):", error);
                const errorMessage = `AI Guardian Error: ${error.message}. Check console.`;
                if (targetElement) {
                    targetElement.textContent = errorMessage;
                    targetElement.style.fontStyle = 'normal';
                }
                addLogMessageToDB(`Error calling AI Guardian LLM (Live): ${error.message}`, 'ERROR');
                return errorMessage;
            }
        }

        askAIButton.addEventListener('click', async () => {
            triggerHapticFeedback();
            const query = aiQueryInput.value.trim();
            if (!query) { aiResponseArea.textContent = "Please type a question for AI Guardian."; aiResponseArea.style.fontStyle='italic'; return; }
            askAIButton.disabled = true;
            addLogMessageToDB(`User asked AI Guardian (Live): "${query}"`, 'INFO');
            await callAIGuardianLLM_DevMode(query, aiResponseArea);
            askAIButton.disabled = false;
            aiQueryInput.value = '';
        });

        analyzeUrlButton.addEventListener('click', async () => {
            triggerHapticFeedback();
            const urlToAnalyze = urlInput.value.trim();
            if (!urlToAnalyze) { aiUrlAnalysisResultEl.textContent = "Please enter a URL."; aiUrlAnalysisResultEl.style.fontStyle='italic'; return; }
            analyzeUrlButton.disabled = true;
            addLogMessageToDB(`User requested URL analysis (Live): "${urlToAnalyze}"`, 'INFO');
            const promptForUrlAnalysis = `As AI Guardian Assistant, analyze the following URL for potential threats to an SME: ${urlToAnalyze}. Consider common phishing tactics, URL structure, HTTPS usage, and any known malicious indicators. Provide a probabilistic threat assessment (LOW, MEDIUM, HIGH) with clear, plain-language reasoning for your assessment and practical advice for an SME owner on how to proceed or verify.`;
            await callAIGuardianLLM_DevMode(promptForUrlAnalysis, aiUrlAnalysisResultEl);
            analyzeUrlButton.disabled = false;
        });

        generateDocsButton.addEventListener('click', async () => {
            triggerHapticFeedback();
            generateDocsButton.disabled = true;
            privacyPolicyOutput.value = ''; 
            termsOfUseOutput.value = '';    
            showLoader(docGenerationStatus, "AI Guardian is drafting document outlines...");

            const docGenUserPrompt = `Generate concise outlines for a standard Privacy Policy and Terms of Use for a small European SME.
Focus on key sections and plain language.
For the Privacy Policy, ensure it mentions GDPR principles like data collection purposes (e.g., for providing services, communication, analytics), data subject rights (access, rectification, erasure, portability), data security measures taken by the SME, use of cookies (with a placeholder for details), data retention period, and contact information for data protection queries.
For the Terms of Use, cover aspects like introduction/acceptance of terms, description of services offered by the SME, user responsibilities/acceptable use, intellectual property ownership of the SME's content, disclaimers of warranties (within reasonable SME limits), limitation of liability, and governing law (suggesting the SME's country of operation).
Provide each policy as a distinct section. Start the Privacy Policy with "## Privacy Policy Outline - [SME Name Placeholder]" and the Terms of Use with "## Terms of Use Outline - [SME Name Placeholder]".
Keep the language simple, direct, and structured with clear headings for each section, suitable for an SME owner to understand as a starting point for further legal consultation. Do not add any conversational intro or outro, just the two documents.`;
            
            const fullResponse = await callAIGuardianLLM_DevMode(docGenUserPrompt, docGenerationStatus);

            if (fullResponse && !fullResponse.startsWith("AI Guardian Error:")) {
                const privacyPolicyMatch = fullResponse.match(/## Privacy Policy Outline(?: - \[SME Name Placeholder\])?([\s\S]*?)## Terms of Use Outline/i);
                const termsOfUseMatch = fullResponse.match(/## Terms of Use Outline(?: - \[SME Name Placeholder\])?([\s\S]*)/i);

                privacyPolicyOutput.value = privacyPolicyMatch ? privacyPolicyMatch[1].trim() : "AI Guardian could not fully parse the Privacy Policy outline from the response. Please see raw response below if available, or try again.";
                termsOfUseOutput.value = termsOfUseMatch ? termsOfUseMatch[1].trim() : "AI Guardian could not fully parse the Terms of Use outline from the response. Please see raw response below if available, or try again.";
                
                if (!privacyPolicyMatch || !termsOfUseMatch) {
                    docGenerationStatus.textContent = 'Document outlines generated with potential parsing issues. Review content carefully.';
                    if (!privacyPolicyMatch) privacyPolicyOutput.value += "\n\nRAW AI RESPONSE (or part of it):\n" + fullResponse.substring(0, 1000);
                    if (!termsOfUseMatch && termsOfUseOutput.value.includes("raw response")) termsOfUseOutput.value += "\n\nRAW AI RESPONSE (or part of it):\n" + fullResponse.substring(fullResponse.indexOf("## Terms of Use Outline"));
                } else {
                    docGenerationStatus.textContent = 'Document outlines generated successfully by AI Guardian. Legal review is essential.';
                }
                docGenerationStatus.style.color = 'var(--text-color)'; // Reset color if it was error
                docGenerationStatus.style.fontStyle = 'normal';

            } else {
                 // Error message already set by callAIGuardianLLM_DevMode in docGenerationStatus
                 if (docGenerationStatus.textContent.includes("AI Guardian Error:")) { // Check if it's an error from the call
                    privacyPolicyOutput.value = "Failed to generate document templates due to an API error.";
                    termsOfUseOutput.value = "Failed to generate document templates due to an API error.";
                 }
            }
            generateDocsButton.disabled = false;
        });

    </script>
</body>
</html>
